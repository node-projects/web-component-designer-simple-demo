import { EventNames } from "../../../../enums/EventNames.js";
import { DesignItem } from "../../../item/DesignItem.js";
import { OverlayLayer } from '../extensions/OverlayLayer.js';
export class RectangleSelectorTool {
  constructor() {
    this.cursor = 'progress';
  }

  pointerEventHandler(designerView, event, currentElement) {
    const currentPoint = designerView.getDesignerMousepoint(event, currentElement, event.type === 'pointerdown' ? null : this._initialPoint);

    switch (event.type) {
      case EventNames.PointerDown:
        event.target.setPointerCapture(event.pointerId);
        this._initialPoint = currentPoint;
        if (!this._rect) this._rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");

        this._rect.setAttribute('class', 'svg-selector');

        this._rect.setAttribute('x', this._initialPoint.x);

        this._rect.setAttribute('y', this._initialPoint.y);

        this._rect.setAttribute('width', 0);

        this._rect.setAttribute('height', 0);

        designerView.overlayLayer.addOverlay(this._rect, OverlayLayer.Foregorund);
        break;

      case EventNames.PointerMove:
        if (this._initialPoint) {
          let w = currentPoint.x - this._initialPoint.x;
          let h = currentPoint.y - this._initialPoint.y;

          if (w >= 0) {
            this._rect.setAttribute('x', this._initialPoint.x);

            this._rect.setAttribute('width', w);
          } else {
            this._rect.setAttribute('x', currentPoint.x);

            this._rect.setAttribute('width', -1 * w);
          }

          if (h >= 0) {
            this._rect.setAttribute('y', this._initialPoint.y);

            this._rect.setAttribute('height', h);
          } else {
            this._rect.setAttribute('y', currentPoint.y);

            this._rect.setAttribute('height', -1 * h);
          }
        }

        break;

      case EventNames.PointerUp:
        event.target.releasePointerCapture(event.pointerId);
        const elements = designerView.rootDesignItem.element.querySelectorAll('*');
        const inSelectionElements = [];
        let point = designerView.overlayLayer.createPoint();

        for (let e of elements) {
          let elementRect = e.getBoundingClientRect();
          point.x = elementRect.left - designerView.containerBoundingRect.left;
          point.y = elementRect.top - designerView.containerBoundingRect.top;

          const p1 = this._rect.isPointInFill(point) || this._rect.isPointInStroke(point);

          point.x = elementRect.left - designerView.containerBoundingRect.left + elementRect.width;
          point.y = elementRect.top - designerView.containerBoundingRect.top;

          const p2 = this._rect.isPointInFill(point) || this._rect.isPointInStroke(point);

          point.x = elementRect.left - designerView.containerBoundingRect.left;
          point.y = elementRect.top - designerView.containerBoundingRect.top + elementRect.height;

          const p3 = this._rect.isPointInFill(point) || this._rect.isPointInStroke(point);

          point.x = elementRect.left - designerView.containerBoundingRect.left + elementRect.width;
          point.y = elementRect.top - designerView.containerBoundingRect.top + elementRect.height;

          const p4 = this._rect.isPointInFill(point) || this._rect.isPointInStroke(point);

          if (p1 && p2 && p3 && p4) {
            const desItem = DesignItem.GetOrCreateDesignItem(e, designerView.serviceContainer, designerView.instanceServiceContainer);
            inSelectionElements.push(desItem);
          }
        }

        designerView.overlayLayer.removeOverlay(this._rect);
        this._rect = null;
        this._initialPoint = null;
        designerView.instanceServiceContainer.selectionService.setSelectedElements(inSelectionElements);
        designerView.serviceContainer.globalContext.finishedWithTool(this);
        break;
    }
  }

  dispose() {}

}