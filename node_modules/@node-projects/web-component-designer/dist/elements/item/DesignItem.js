import { CssStyleChangeAction } from "../services/undoService/transactionItems/CssStyleChangeAction.js";
import { NodeType } from "./NodeType.js";
import { AttributeChangeAction } from "../services/undoService/transactionItems/AttributeChangeAction.js";
import { PropertyChangeAction } from "../services/undoService/transactionItems/PropertyChangeAction.js";
const hideAtDesignTimeAttributeName = 'node-projects-hide-at-design-time';
const hideAtRunTimeAttributeName = 'node-projects-hide-at-run-time';
const lockAtDesignTimeAttributeName = 'node-projects-lock-at-design-time';
export class DesignItem {
  constructor(node, serviceContainer, instanceServiceContainer) {
    this.appliedDesignerExtensions = new Map();
    this.node = node;
    this.serviceContainer = serviceContainer;
    this.instanceServiceContainer = instanceServiceContainer;
    this.attributes = new Map();
    this.styles = new Map();

    DesignItem._designItemMap.set(node, this);
  }

  replaceNode(newNode) {
    DesignItem._designItemMap.delete(this.node);

    DesignItem._designItemMap.set(newNode, this);

    this.node = newNode;
  }

  get nodeType() {
    if (this.node instanceof Comment) return NodeType.Comment;
    if (this.node instanceof Text) return NodeType.TextNode;
    return NodeType.Element;
  }

  get hasAttributes() {
    return this.attributes.size > 0;
  }

  get hasStyles() {
    return this.styles.size > 0;
  }

  get element() {
    return this.node;
  }

  get name() {
    return this.element.localName;
  }

  get id() {
    return this.element.id;
  }

  set id(value) {
    this.element.id = value;
  }

  get hasChildren() {
    return this.element.childNodes.length > 0;
  }

  *children() {
    for (const e of this.element.childNodes) {
      yield DesignItem.GetOrCreateDesignItem(e, this.serviceContainer, this.instanceServiceContainer);
    }
  }

  get childCount() {
    return this.element.childNodes.length;
  }

  get firstChild() {
    return this.getOrCreateDesignItem(this.element.childNodes[0]);
  }

  get parent() {
    return this.getOrCreateDesignItem(this.element.parentNode);
  }

  get hasContent() {
    return this.nodeType == NodeType.TextNode || this.element.childNodes.length === 0 && this.content !== null;
  }

  get content() {
    return this.node.textContent;
  }

  set content(value) {
    this.node.textContent = value;
  }

  get hideAtDesignTime() {
    return this._hideAtDesignTime;
  }

  set hideAtDesignTime(value) {
    var _a;

    this._hideAtDesignTime = value;
    if (value) this.attributes.set(hideAtDesignTimeAttributeName, "");else this.attributes.delete(hideAtDesignTimeAttributeName);

    if (this.element instanceof HTMLElement || this.element instanceof SVGElement) {
      if (!value) this.element.style.display = (_a = this.styles.get('display')) !== null && _a !== void 0 ? _a : "";else this.element.style.display = 'none';
    }
  }

  get hideAtRunTime() {
    return this._hideAtRunTime;
  }

  set hideAtRunTime(value) {
    var _a;

    this._hideAtRunTime = value;
    if (value) this.attributes.set(hideAtRunTimeAttributeName, "");else this.attributes.delete(hideAtRunTimeAttributeName);

    if (this.element instanceof HTMLElement || this.element instanceof SVGElement) {
      if (!value) this.element.style.opacity = (_a = this.styles.get('opacity')) !== null && _a !== void 0 ? _a : "";else this.element.style.opacity = '0.3';
    }
  }

  get lockAtDesignTime() {
    return this._lockAtDesignTime;
  }

  set lockAtDesignTime(value) {
    this._lockAtDesignTime = value;
    if (value) this.attributes.set(lockAtDesignTimeAttributeName, "");else this.attributes.delete(lockAtDesignTimeAttributeName);

    if (this.element instanceof HTMLElement || this.element instanceof SVGElement) {
      if (!value) this.element.style.pointerEvents = 'auto';else this.element.style.pointerEvents = 'none';
    }
  }

  static createDesignItemFromInstance(node, serviceContainer, instanceServiceContainer) {
    let designItem = new DesignItem(node, serviceContainer, instanceServiceContainer);

    for (let a of designItem.element.attributes) {
      if (a.name !== 'style') {
        designItem.attributes.set(a.name, a.value);
        if (a.name === hideAtDesignTimeAttributeName) designItem._hideAtDesignTime = true;
        if (a.name === hideAtRunTimeAttributeName) designItem._hideAtRunTime = true;
        if (a.name === lockAtDesignTimeAttributeName) designItem._lockAtDesignTime = true;
      }
    }

    if (node instanceof HTMLElement || node instanceof SVGElement) {
      for (let s of node.style) {
        let val = node.style[s];
        if (val && typeof val === 'string') designItem.styles.set(s, node.style[s]);
      }

      if (!designItem._lockAtDesignTime) node.style.pointerEvents = 'auto';else node.style.pointerEvents = 'none'; //node.style.cursor = 'pointer';
    }

    node.draggable = false; //even if it should be true, for better designer exp.

    if (designItem.element.children.length === 0) designItem.content = designItem.element.textContent;
    return designItem;
  }

  openGroup(title, affectedItems) {
    return this.instanceServiceContainer.undoService.openGroup(title, affectedItems);
  }

  getOrCreateDesignItem(node) {
    return DesignItem.GetOrCreateDesignItem(node, this.serviceContainer, this.instanceServiceContainer);
  }

  static GetOrCreateDesignItem(node, serviceContainer, instanceServiceContainer) {
    if (!node) return null;

    let designItem = DesignItem._designItemMap.get(node);

    if (!designItem) {
      designItem = new DesignItem(node, serviceContainer, instanceServiceContainer);
    }

    return designItem;
  }

  static GetDesignItem(node) {
    if (!node) return null;

    let designItem = DesignItem._designItemMap.get(node);

    return designItem;
  }

  setStyle(name, value) {
    const action = new CssStyleChangeAction(this, name, value, this.styles.get(name));
    this.instanceServiceContainer.undoService.execute(action);
  }

  removeStyle(name) {
    const action = new CssStyleChangeAction(this, name, '', this.styles.get(name));
    this.instanceServiceContainer.undoService.execute(action);
  }

  setAttribute(name, value) {
    const action = new AttributeChangeAction(this, name, value, this.attributes.get(name));
    this.instanceServiceContainer.undoService.execute(action);
  }

  removeAttribute(name) {
    const action = new AttributeChangeAction(this, name, null, this.attributes.get(name));
    this.instanceServiceContainer.undoService.execute(action);
  }

  setProperty(name, value) {
    const propService = this.serviceContainer.getLastServiceWhere('propertyService', x => x.isHandledElement(this));
    const property = propService.getProperty(this, name);
    const oldValue = propService.getValue([this], property);
    const action = new PropertyChangeAction(this, property, value, oldValue);
    this.instanceServiceContainer.undoService.execute(action);
  }

  removeProperty(name, value) {
    const propService = this.serviceContainer.getLastServiceWhere('propertyService', x => x.isHandledElement(this));
    const property = propService.getProperty(this, name);
    const oldValue = propService.getValue([this], property);
    const action = new PropertyChangeAction(this, property, undefined, oldValue);
    this.instanceServiceContainer.undoService.execute(action);
  }

}
DesignItem._designItemMap = new WeakMap();